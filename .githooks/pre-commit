#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#  Flow F 自动检查 — git pre-commit hook
#  三位一体 + 编码铁律 + 代码卫生
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

STAGED=$(git diff --cached --name-only --diff-filter=ACMR)
ERRORS=0
WARNINGS=""

# ── 分类暂存文件 ──

HAS_CODE=false
HAS_TEST=false
HAS_DOC=false

for f in $STAGED; do
  case "$f" in
    src/*.ts|src/*.vue) HAS_CODE=true ;;
    tests/*.spec.ts|tests/*.spec.js) HAS_TEST=true ;;
    *.md|docs/*) HAS_DOC=true ;;
  esac
done

# 无代码变更，跳过全部检查
if [ "$HAS_CODE" = false ]; then
  exit 0
fi

# ── 三位一体 ──

if [ "$HAS_TEST" = false ]; then
  WARNINGS="${WARNINGS}\n${YELLOW}⚠ 缺测试: 代码变更但没有 .spec.ts 文件${NC}"
  ERRORS=$((ERRORS + 1))
fi

if [ "$HAS_DOC" = false ]; then
  WARNINGS="${WARNINGS}\n${YELLOW}⚠ 缺文档: 代码变更但没有 .md 文件${NC}"
  ERRORS=$((ERRORS + 1))
fi

# ── 文件行数限制 (分级) ──
#  utils ≤ 100 | 声明 ≤ 300 | 逻辑 ≤ 200 | Vue ≤ 400
#  匹配顺序即优先级: 先特殊后默认

for f in $STAGED; do
  [ ! -f "$f" ] && continue
  LIMIT=0; TAG=""
  case "$f" in
    src/utils/*.ts)
      LIMIT=100; TAG="工具 TS" ;;
    *Types.ts|*/types.ts|*Defs.ts|*Presets.ts)
      case "$f" in src/*) LIMIT=300; TAG="声明 TS" ;; esac ;;
    src/*.ts)
      LIMIT=200; TAG="逻辑 TS" ;;
    src/*.vue)
      LIMIT=400; TAG="Vue SFC" ;;
  esac
  [ "$LIMIT" -eq 0 ] && continue
  LINES=$(wc -l < "$f" 2>/dev/null || echo 0)
  if [ "$LINES" -gt "$LIMIT" ]; then
    WARNINGS="${WARNINGS}\n${RED}❌ ${TAG}超标: $f ($LINES 行 > $LIMIT)${NC}"
    ERRORS=$((ERRORS + 1))
  fi
done

# ── 禁止 any / @ts-ignore ──

for f in $STAGED; do
  [ ! -f "$f" ] && continue
  case "$f" in
    src/*.ts|src/*.vue)
      if grep -qnE '\bany\b' "$f" 2>/dev/null; then
        # 排除注释行和类型守卫
        HITS=$(grep -nE '\bany\b' "$f" | grep -v '//.*any' | grep -v '\* .*any' | grep -v "'any'" | grep -v '"any"' | head -3)
        if [ -n "$HITS" ]; then
          WARNINGS="${WARNINGS}\n${YELLOW}⚠ 疑似 any 类型: $f${NC}\n   ${HITS}"
        fi
      fi
      if grep -qn '@ts-ignore' "$f" 2>/dev/null; then
        WARNINGS="${WARNINGS}\n${RED}❌ 禁止 @ts-ignore: $f${NC}"
        ERRORS=$((ERRORS + 1))
      fi
      ;;
  esac
done

# ── 目录卫生: tests/ 不允许非测试文件 ──

for f in $STAGED; do
  case "$f" in
    tests/*)
      BASENAME=$(basename "$f")
      case "$BASENAME" in
        *.spec.ts|*.spec.js) ;; # 允许
        journey-server.mjs|persona.spec.ts) ;; # 已知文件
        *.png|*.webm) ;; # 截图和视频
        *) WARNINGS="${WARNINGS}\n${YELLOW}⚠ tests/ 目录卫生: $f 不是 .spec.ts 文件${NC}" ;;
      esac
      ;;
  esac
done

# ── 临时文件检查 ──

for f in $STAGED; do
  BASENAME=$(basename "$f")
  case "$BASENAME" in
    repro-*|debug-*|temp-*)
      WARNINGS="${WARNINGS}\n${RED}❌ 临时文件不应提交: $f${NC}"
      ERRORS=$((ERRORS + 1))
      ;;
  esac
done

# ── 输出结果 ──

if [ -n "$WARNINGS" ]; then
  echo -e "\n${RED}━━━ Flow F 自动检查 ━━━${NC}"
  echo -e "$WARNINGS"
  if [ $ERRORS -gt 0 ]; then
    echo -e "\n${YELLOW}提示: 用 git commit --no-verify 跳过 (仅紧急情况)${NC}\n"
    exit 1
  fi
  echo -e "\n${GREEN}✓ 有警告但允许提交${NC}\n"
fi

echo -e "${GREEN}✓ Flow F 检查通过${NC}"
exit 0
