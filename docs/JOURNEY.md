# Intera — Flow E: 角色旅程验证

> AI 驱动·逐步探索。像用户一样操作产品，发现摩擦就修，修完重走，循环至丝滑。
> 触发词: "角色旅程" / "打磨体验" / "验证一下体验" / "帮我看看好不好用"

---

## 禁止事项

- ⛔ 不要运行 `npx playwright test tests/persona.spec.ts`，那是能力回归，不是旅程
- ⛔ 不要提前规划所有步骤，不要写脚本
- ⛔ 不要在没看截图的情况下执行下一步操作
- ⛔ 不要反复打开关闭浏览器。打开一次，全程保持同一窗口
- ⛔ **不要写多步合并脚本** — 禁止把多个操作写进一个 Playwright/JS 脚本一次性执行再回头看截图。这和「提前规划所有步骤」是完全相同的违规。每次只执行一个动作，看到结果再决定下一步
- ⛔ 不要用 `npx playwright test` 驱动旅程探索。旅程用浏览器工具交互，不是自动化测试框架

---

## 能力图谱 → 画像自动生成

```
能力图谱:
  states ─────┬── curves ──┐
              └── patch ───┴── folme
```

扩展: 在图谱加一个能力 → 新画像自动涌现。

6 个画像从能力图谱自动枚举:
∅ / {states} / {states,curves} / {states,patch} / {states,curves,patch} / 全能力

**设计目标由 AI 动态生成**，不预置。
AI 拿到能力集后，自己构思一个完整的交互动效设计任务。
- 任务必须覆盖该画像的所有能力，产出是完成的设计作品
- 同一画像可跑不同复杂度 (简单/中等/复杂)
- 多轮验证时变换设计任务，覆盖更多场景

---

## 工具: journey-server (唯一正确方式)

通过 `tests/journey-server.mjs` 逐步操作浏览器。每次 `curl` = 一个动作 + 一张截图。
浏览器由 server 常驻管理，AI 无法批量执行。

```bash
# 启动 (后台运行)
node tests/journey-server.mjs --dir docs/journeys/{旅程文件夹} --port 3900 &

# 每步一个 curl (返回 {"step":N,"screenshot":"path"})
# 所有操作都是坐标 + 键盘，像真实用户一样看到什么点什么
curl -s localhost:3900/step -d '{"action":"screenshot"}'              # 看屏幕
curl -s localhost:3900/step -d '{"action":"mouse","x":500,"y":300}'   # 点击
curl -s localhost:3900/step -d '{"action":"dblclick","x":100,"y":350}'  # 双击
curl -s localhost:3900/step -d '{"action":"rightclick","x":100,"y":350}'  # 右键
curl -s localhost:3900/step -d '{"action":"hover","x":500,"y":300}'   # 悬停
curl -s localhost:3900/step -d '{"action":"drag","x1":400,"y1":200,"x2":600,"y2":400}'  # 拖拽
curl -s localhost:3900/step -d '{"action":"press","key":"r"}'         # 按键/快捷键
curl -s localhost:3900/step -d '{"action":"keyboard","text":"Hello"}' # 打字
curl -s localhost:3900/step -d '{"action":"scroll","x":900,"y":400,"deltaY":200}'  # 滚动

# 修改输入框值的方式 (不用选择器，像用户一样操作):
#   mouse(x,y) → press("Control+a") → keyboard("360") → press("Enter")
# 使用下拉框的方式:
#   mouse(x,y) → screenshot → mouse(选项坐标)

# 结束
curl -s localhost:3900/step -d '{"action":"save"}'   # 导出 design.intera
curl -s localhost:3900/step -d '{"action":"stop"}'   # 关闭浏览器
```

---

## 核心协议: 一次一步，看完再动

```
1. 选画像，构思设计任务，不规划步骤
2. 启动 journey-server (后台，浏览器常驻)
3. 循环 {
     a. curl screenshot → Read 截图文件查看
     b. 描述截图中看到了什么 (具体画面内容)
     c. 基于画面 + 设计任务，决定下一步 (只决定一步)
     d. curl 执行这一步 → Read 截图查看结果
     e. 回到 b
   }
4. 设计任务完成 → 体验审查 (见下方) → 归档旅程 (README.md + design.intera + 截图)
5. 摩擦点同步到 docs/KNOWN-ISSUES.md 摩擦日志   ← ⚠️ 不可跳过
6. git add + git commit 旅程归档   ← ⚠️ 不可跳过
7. 有摩擦 → **立即修代码** (无需确认，除非改动面很大) → git commit → 能力回归 → 重走旅程
8. 无摩擦 → 标记 ✅ → 下一画像，依然走本流程
```

---

## 体验审查 (设计任务完成后必做)

> 功能验证只回答"能不能用"，体验审查回答"好不好用"。
> 两者都通过才能标 ✅。

**三个维度，逐项检查:**

**① 视觉一致性 (自动化)**
```
检查项:
□ 属性面板: 标签对齐、输入框样式统一、间距均匀
□ Patch 编辑器: 节点大小一致、端口位置对齐、连线清晰
□ 状态栏/工具栏: 激活态视觉反馈明确（下划线/高亮）
□ 字体: 全局字体大小层次分明（标题 > 正文 > 标签 > 辅助）
□ 颜色: 前景/背景对比度足够，覆盖态橙色标记可辨识
□ 间距: 同级元素间距一致，分组间有明确分隔
```
方法: 截图 → 逐项目视检查 → 用 getComputedStyle 断言关键属性
摩擦类型: `visual-inconsistency`

**② 动画流畅度 (半自动化)**
```
检查项:
□ 弹簧动画: 有明显的回弹感，不是线性过渡
□ 状态切换: 过渡自然，无跳帧或闪烁
□ 响应速度: 点击后 <100ms 开始动画，无明显延迟
□ 多元素: 多个元素同时动画时不卡顿
□ 快速操作: 连续快速点击不会导致动画错乱或状态混乱
```
方法: 录制视频 → AI 自己逐帧审查 → 发给 kenefe 前先确认质量
摩擦类型: `animation-quality`

**③ 交互品味 (人工审查)**
```
检查项:
□ 操作直觉: 不看说明能猜到怎么用
□ 反馈及时: 每个操作都有即时视觉反馈
□ 整体感觉: 像一个成熟产品，不像原型/demo
□ 细节打磨: 无溢出、无截断、无对不齐的像素
□ 动效品味: 弹簧参数是否舒服（不过弹、不过硬）
```
方法: 录制 1080p 视频 → AI 先自审 → 发给 kenefe 审查
摩擦类型: `taste-issue`

**体验审查输出格式 (写入旅程 README.md):**
```markdown
## 体验审查

### 视觉一致性
- ✅/❌ 属性面板对齐: ...
- ✅/❌ Patch 节点一致性: ...
- ...

### 动画流畅度
- ✅/❌ 弹簧回弹感: ...
- ✅/❌ 快速操作稳定性: ...
- ...

### 交互品味 (待 kenefe 审查)
- 视频: screenshots/preview-demo.webm
- AI 自评: ...
```

**铁律**: 体验审查发现的问题和功能摩擦同等对待 — 必须记录到 KNOWN-ISSUES.md，修复后重走验证。

---

## 操作偏好 (像真实设计师 — 零选择器)

- **只有坐标和键盘** — 从截图估算位置，用 `mouse`/`drag`/`dblclick`/`rightclick`/`hover`。选择器已从 server 移除
- **拖拽 > 输入框** — 调整尺寸/位置时优先拖拽手柄
- **改输入框值** — `mouse` 点击输入框 → `press("Control+a")` 全选 → `keyboard("新值")` → `press("Enter")`
- **用下拉框** — `mouse` 点击下拉 → `screenshot` 看选项 → `mouse` 点击选项坐标
- **滚动** — `scroll` 传鼠标位置 (x,y) 和滚动量 (deltaX/deltaY)
- **禁止 eval / 禁止选择器** — server 不提供这些能力，从架构上杜绝

---

## 产品快捷键 (设计师常用)

| 按键 | 功能 |
|---|---|
| `v` | 选择工具 |
| `r` | 矩形工具 |
| `o` | 椭圆工具 |
| `f` | Frame 工具 |
| `t` | 文本工具 |
| `Arrow` | 微调选中图层 1px |
| `Shift+Arrow` | 微调选中图层 10px |
| `Delete` / `Backspace` | 删除选中图层 |
| `Ctrl+Z` | 撤销 |
| `Ctrl+Shift+Z` | 重做 |
| `Ctrl+S` | 保存 |

---

## 铁律 — 不可违反

- ⛔ **每个画像质量一致** — 第 6 个画像和第 1 个画像必须一样详细。每一步都必须有截图 + 描述 + 决策。不允许后面的画像草率概括或批量处理
- ⛔ **摩擦点双写** — 每条摩擦点必须同时写入两处: (1) 旅程 README.md 的「摩擦点」区 (2) `docs/KNOWN-ISSUES.md` 的「摩擦日志」表。只写一处 = 没写
- ⛔ **摩擦点即时修复** — 发现摩擦不是记笔记。旅程归档后 **立即修代码，无需确认** (除非改动面超过 3 个文件或影响核心架构)。流程: 记录到 README + KNOWN-ISSUES → 修代码 → git commit → 能力回归 → 重走旅程验证修复生效
- ⛔ **摩擦修复循环** — 旅程发现摩擦 → 修代码 → commit → 回归测试 → 用同一画像重走旅程。循环直到该画像零摩擦才能标 ✅ 进入下一画像
- ⛔ **代码·测试·文档三位一体** — 任何功能修改/新增/修复，必须同时更新: (1) 代码 (2) BDD 测试 (3) 相关文档。三者必须在同一次 commit 中完成。缺任何一项 = 未完成

---

## 旅程归档

每次旅程完成后，追加一份归档。每次新建文件，不覆盖。

文件结构:
```
docs/journeys/{YYYYMMDD_HHmm}-{画像id}-{简述}/    ← 时间用北京时间 (GMT+8)
  README.md          ← 旅程记录 (过程 + 结论)
  design.intera      ← 最终设计文件
  screenshots/
    step-01.png
    step-02.png
    ...
```

README.md 格式 — **叙事式逐步记录** (每步都是一次认知):

```markdown
# 旅程: {画像} — {设计目标简述}

## 画像
{能力集描述}

## 设计目标
{AI 构思的设计任务，列出具体元素}

## 过程

### Step N — {动作描述}
![step-NN](screenshots/step-NN.png)
{看到了什么}: 截图中的具体画面内容、面板状态、元素位置。
{感受}: 操作手感、响应速度、是否符合直觉。
{摩擦点 (如有)}: **摩擦点 #N**: 详细描述现象 + 预期 vs 实际。

### Step M — {下一个关键动作}
...

## 摩擦点汇总
| # | 严重度 | 描述 | 状态 |
|---|--------|------|------|

## 体验审查
### 视觉一致性 / 动画流畅度 / 交互品味
{逐项 ✅/❌}

## 结论
{通过 / 有摩擦待修}
```

**铁律**: 每步必须有 **截图 + 观察 + 感受**。可以合并连续的机械操作 (如 Step 8-11)，但关键帧和摩擦点必须单独成段。

设计文件获取: 旅程结束时通过浏览器控制台读取 `localStorage.getItem('intera_project')` 保存为 `design.intera`

---

## Git 提交

**旅程归档**完成后，立即提交:
```bash
git add docs/journeys/{旅程文件夹}/
git commit -m "journey: {画像id} — {设计目标简述}"
```

**修代码**后，也必须立即提交:
```bash
git add -A
git commit -m "fix: {修复了什么摩擦点}"
```

不提交 = 不存在。旅程归档和代码修复都不可跳过 git commit。

---

## 两层验证体系

| | 旅程探索 (本流程) | 能力回归 (persona.spec.ts) |
|--|--|--|
| **执行者** | AI 看截图逐步操作 | Playwright 自动跑 |
| **决策者** | AI (每步看画面决定) | 代码 (确定性序列) |
| **验证什么** | 体验是否丝滑 | 功能是否完好 |
| **何时跑** | 打磨体验时 | 修完代码后回归 |
